# Testing Guide

–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Home Assistant Telegram Bot.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=. --cov-report=html --cov-report=term-missing

# –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è —Ç–µ—Å—Ç–æ–≤
pytest tests/test_basic.py -v

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
pytest tests/test_basic.py::TestBasicFunctionality::test_imports -v
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (`test_basic.py`)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –º–æ–¥—É–ª–µ–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π

**–°—Ç–∞—Ç—É—Å**: –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (8/8)

### –¢–µ—Å—Ç—ã Home Assistant API (`test_home_assistant.py`)
- ‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ —Ç–∏–ø—É
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º –∏ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏

**–°—Ç–∞—Ç—É—Å**: –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç (—Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è –º–æ–∫–∏–Ω–≥–∞)

### –¢–µ—Å—Ç—ã Telegram –±–æ—Ç–∞ (`test_bot.py`)
- ‚ö†Ô∏è –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
- ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- ‚ö†Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Home Assistant API

**–°—Ç–∞—Ç—É—Å**: –¢—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤ telegram-bot

### –¢–µ—Å—Ç—ã Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`test_app.py`)
- ‚úÖ HTTP —Ä–æ—É—Ç—ã –∏ –æ—Ç–≤–µ—Ç—ã
- ‚ö†Ô∏è API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- ‚ö†Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

**–°—Ç–∞—Ç—É—Å**: –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–æ—É—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫ (`test_metrics.py`)
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MetricsCollector
- ‚úÖ –ó–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚ö†Ô∏è –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–°—Ç–∞—Ç—É—Å**: –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

**–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**: 55%

### –ü–æ –º–æ–¥—É–ª—è–º:
- `metrics.py`: 82% (–æ—Ç–ª–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ)
- `app.py`: 54% (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤)
- `home_assistant.py`: 31% (—Ç—Ä–µ–±—É–µ—Ç –º–æ–∫–∏–Ω–≥–∞ HTTP)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### pytest.ini
```ini
[tool:pytest]
testpaths = tests
addopts = --verbose --cov=. --cov-report=html:htmlcov --cov-report=xml:coverage.xml
asyncio_mode = auto
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
```bash
HOME_ASSISTANT_URL=http://test-ha.local:8123
HOME_ASSISTANT_TOKEN=test_token_123
TELEGRAM_BOT_TOKEN=test_bot_token_456
SESSION_SECRET=test_secret_key
```

## –§–∏–∫—Å—Ç—É—Ä—ã (conftest.py)

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã:
- `mock_home_assistant`: –ú–æ–∫ Home Assistant API
- `mock_update`: –ú–æ–∫ Telegram Update –æ–±—ä–µ–∫—Ç–∞
- `mock_context`: –ú–æ–∫ Telegram Context
- `flask_app`: Flask test client
- `mock_metrics`: –ú–æ–∫ —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫
- `mock_environment`: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –ó–∞–ø—É—Å–∫ –≤ CI/CD

### GitHub Actions
```yaml
# .github/workflows/ci.yml
- name: Run tests with coverage
  run: pytest --cov=. --cov-report=xml --verbose

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3
```

### Docker —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
docker build -t ha-telegram-bot:test .

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker run --rm ha-telegram-bot:test pytest
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏ telegram
**–û—à–∏–±–∫–∞**: `ImportError: cannot import name 'Update' from 'telegram'`

**–†–µ—à–µ–Ω–∏–µ**: –¢–µ—Å—Ç—ã –¥–ª—è telegram-bot –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

### –ü—Ä–æ–±–ª–µ–º–∞ —Å HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
**–û—à–∏–±–∫–∞**: `ConnectionError: Failed to resolve 'test-ha.local'`

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–∫–∏–Ω–≥ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

### –ü—Ä–æ–±–ª–µ–º–∞ —Å async —Ç–µ—Å—Ç–∞–º–∏
**–û—à–∏–±–∫–∞**: `RuntimeError: There is no current event loop`

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `@pytest.mark.asyncio` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
```python
def test_new_functionality(self):
    """Test description"""
    # Arrange
    expected_result = "test_value"
    
    # Act
    result = function_to_test()
    
    # Assert
    assert result == expected_result
```

### –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```python
@patch('module.external_service')
def test_with_mock(self, mock_service):
    mock_service.return_value = "mocked_response"
    # Test logic here
```

## –¶–µ–ª–∏ —É–ª—É—á—à–µ–Ω–∏—è

### –ë–ª–∏–∂–∞–π—à–∏–µ –∑–∞–¥–∞—á–∏:
1. ‚úÖ –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
2. üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ telegram-bot –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
3. üîÑ –£–ª—É—á—à–µ–Ω–∏–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
4. üìã –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–æ 80%
5. üìã –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–æ–º–º–∏—Ç–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–∞–¥–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤
- Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫
- E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Docker Compose

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç. –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, CI/CD pipeline –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.